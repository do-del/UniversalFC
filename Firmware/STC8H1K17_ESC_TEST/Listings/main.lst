C51 COMPILER V9.60.0.0   MAIN                                                              01/16/2023 09:21:50 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_c51\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\mai
                    -n.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "stc8h.h"
   2          #include <intrins.h>
   3          
   4          /*
   5           * PWM1接P1.0，配置推挽输出和PWM输出，控制电机U相高位MOS管选通信号，高电平导通，低电平截止
   6           * PWM1_L接P1.1，配置推挽输出，控制电机U相低位MOS管选通信号，高电平导通，低电平截止
   7           * PWM2接P1.2，配置推挽输出和PWM输出，控制电机V相高位MOS管选通信号，高电平导通，低电平截止
   8           * PWM2_L接P1.3，配置推挽输出，控制电机V相低位MOS管选通信号，高电平导通，低电平截止
   9           * PWM3接P1.4，配置推挽输出和PWM输出，控制电机W相高位MOS管选通信号，高电平导通，低电平截止
  10           * PWM3_L接P1.5，配置推挽输出，控制电机W相低位MOS管选通信号，高电平导通，低电平截止
  11           * ADC8（P0.0），配置高阻输入，采样电机U相感应电动势，用于过零检测比较器正输入
  12           * ADC9（P0.1），配置高阻输入，采样电机V相感应电动势
  13           * ADC10（P0.2），配置高阻输入，采样电机W相感应电动势
  14           * CMP-（P3.6），配置为高阻输入，接过零检测电路中点
  15          */
  16          
  17          /*
  18           * 无刷电机通电次序
  19           * AB-AC-BC-BA-CA-CB-AB
  20           * 相对应感应电动势变化
  21           * C下降-B上升-A下降-C上升-B下降-A上升-C下降
  22          */
  23          
  24          #include "sys.h"
  25          #include "common.h"
  26          #include "uart.h"
  27          #include "pwm.h"
  28          #include "adc.h"
  29          #include "motor.h"
  30          #include "timer.h"
  31          #include "cmp.h"
  32          #include "beep.h"
  33          
  34          u16 cap_res_g[8];
  35          u16 cap_res_lp;
  36          
  37          void Port_Init(void); //芯片复位后引脚初始化
  38          
  39          void main(void)
  40          {
  41   1        u8  i;
  42   1        u8 j;
  43   1        u32 sum;
  44   1        
  45   1        P_SW2 |= 0x80; //使能XFR
  46   1        
  47   1        Port_Init();  //调用端口初始化函数
  48   1        
  49   1        PWMA_Config();  //调用PWMA初始化函数
  50   1        ADC_Config(); //调用ADC初始化函数
  51   1        CMP_Config(); //调用模拟比较器初始化函数
  52   1        Timer0_Config();  //调用定时器0初始化函数
  53   1        Timer3_Config();  //调用定时器3初始化函数
  54   1        Timer4_Config();  //调用定时器4初始化函数
C51 COMPILER V9.60.0.0   MAIN                                                              01/16/2023 09:21:50 PAGE 2   

  55   1      
  56   1        PWMB_Config();
  57   1        
  58   1        Uart_Config();  //调用串口初始化函数
  59   1        ES = 1;
  60   1        
  61   1        PWM_Set = 0;
  62   1        PWM_Value = 0;
  63   1        timeout = 0;
  64   1        
  65   1        Delay_n_ms(250);
  66   1        beep_1KHz(500);
  67   1        Delay_n_ms(250);
  68   1        
  69   1        EA = 1; //打开总中断
  70   1        
  71   1        UartSendStr("--Brushless ESC Test--\r\n");
  72   1        
  73   1        
  74   1        while(1)
  75   1        {
  76   2          if(t0_flag)
  77   2          {
  78   3            t0_flag = 0;
  79   3            
  80   3            if(timeout != 0)
  81   3            {
  82   4              if(--timeout == 0)
  83   4              {
  84   5                m_running = 0;
  85   5                PWM_Value = 0;
  86   5                CMPCR1 = 0x8c;
  87   5                PWMA_ENO = 0;
  88   5                PWMA_CCR1 = 0;
  89   5                PWMA_CCR2 = 0;
  90   5                PWMA_CCR3 = 0;
  91   5                PWM1_L = 0;
  92   5                PWM2_L = 0;
  93   5                PWM3_L = 0;
  94   5                Delay_n_ms(250);
  95   5              }
  96   4            }
  97   3            if(!m_running && (PWM_Set >= D_START_PWM))
  98   3            {
  99   4              m_starting = 1;
 100   4              for(i = 0;i<8;i++) phase_time_tmp[i] = 400; 
 101   4              Motor_Start();
 102   4              m_starting = 0;
 103   4              demagnetizing_cnt = 0;
 104   4              CMPCR1 &= ~0x40;
 105   4              if(step & 1)  CMPCR1 = 0xAC;    //上升沿中断
 106   4              else      CMPCR1 = 0x9C;    //下降沿中断
 107   4              m_running = 1;
 108   4              Delay_n_ms(250);  //延时一下, 先启动起来
 109   4              Delay_n_ms(250);
 110   4              timeout = 125;    //启动超时时间 125*4 = 500ms
 111   4            }
 112   3            if(m_running)
 113   3            {
 114   4              if(PWM_Value < PWM_Set) PWM_Value++;
 115   4              if(PWM_Value > PWM_Set) PWM_Value--;
 116   4              if(PWM_Value<(D_START_PWM-5))
C51 COMPILER V9.60.0.0   MAIN                                                              01/16/2023 09:21:50 PAGE 3   

 117   4              {
 118   5                m_running = 0;
 119   5                PWM_Value = 0;
 120   5                CMPCR1 = 0x8c;
 121   5                PWMA_ENO = 0;
 122   5                PWM1_L = 0;
 123   5                PWM2_L = 0;
 124   5                PWM3_L = 0;
 125   5              }
 126   4              PWMA_CCR1L = PWM_Value;
 127   4              PWMA_CCR2L = PWM_Value;
 128   4              PWMA_CCR3L = PWM_Value;
 129   4            }
 130   3            
 131   3            cap_res_g[j] = pwmb_cap_res;
 132   3            j++;
 133   3            j &= 0x07;
 134   3            for(sum = 0,i = 0;i<8;i++)
 135   3            {
 136   4              sum += cap_res_g[i];
 137   4            }
 138   3            cap_res_lp = sum>>4;
 139   3            if(cap_res_lp<1100)
 140   3            {
 141   4              PWM_Set = 25;
 142   4            }
 143   3            else if(cap_res_lp>1900)
 144   3            {
 145   4              PWM_Set = 230;
 146   4            }
 147   3            else if((cap_res_lp>=1100) && (cap_res_lp <= 1900))
 148   3            {
 149   4              PWM_Set = (u8)((cap_res_lp - 1000)>>2);
 150   4            }   
 151   3          }
 152   2        }
 153   1      }
 154          
 155          void Port_Init(void)
 156          {
 157   1        P0M0 = 0x00;
 158   1        P0M1 = 0x00; //P0端口初始化为双向口
 159   1        P1M0 = 0x00;
 160   1        P1M1 = 0x00; //P1端口初始化为双向口
 161   1        P2M0 = 0x00;
 162   1        P2M1 = 0x00; //P2端口初始化为双向口
 163   1        P3M0 = 0x00;
 164   1        P3M1 = 0x00; //P3端口初始化为双向口
 165   1        P5M0 = 0x00;
 166   1        P5M0 = 0x00; //P5端口初始化为双向口
 167   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1715    ----
   CONSTANT SIZE    =     25    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     67       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7    ----
END OF MODULE INFORMATION.

C51 COMPILER V9.60.0.0   MAIN                                                              01/16/2023 09:21:50 PAGE 4   


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
