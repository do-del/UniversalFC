C51 COMPILER V9.60.0.0   MAIN                                                              01/16/2023 21:40:02 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil51\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main.
                    -lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "stc8h.h"
   2          #include <intrins.h>
   3          
   4          /*
   5           * PWM1接P1.0，配置推挽输出和PWM输出，控制电机U相高位MOS管选通信号，高电平导通，低电平截止
   6           * PWM1_L接P1.1，配置推挽输出，控制电机U相低位MOS管选通信号，高电平导通，低电平截止
   7           * PWM2接P1.2，配置推挽输出和PWM输出，控制电机V相高位MOS管选通信号，高电平导通，低电平截止
   8           * PWM2_L接P1.3，配置推挽输出，控制电机V相低位MOS管选通信号，高电平导通，低电平截止
   9           * PWM3接P1.4，配置推挽输出和PWM输出，控制电机W相高位MOS管选通信号，高电平导通，低电平截止
  10           * PWM3_L接P1.5，配置推挽输出，控制电机W相低位MOS管选通信号，高电平导通，低电平截止
  11           * ADC8（P0.0），配置高阻输入，采样电机U相感应电动势，用于过零检测比较器正输入
  12           * ADC9（P0.1），配置高阻输入，采样电机V相感应电动势
  13           * ADC10（P0.2），配置高阻输入，采样电机W相感应电动势
  14           * CMP-（P3.6），配置为高阻输入，接过零检测电路中点
  15          */
  16          
  17          /*
  18           * 无刷电机通电次序
  19           * AB-AC-BC-BA-CA-CB-AB
  20           * 相对应感应电动势变化
  21           * C下降-B上升-A下降-C上升-B下降-A上升-C下降
  22          */
  23          
  24          #include "sys.h"
  25          #include "common.h"
  26          #include "uart.h"
  27          #include "pwm.h"
  28          #include "adc.h"
  29          #include "motor.h"
  30          #include "timer.h"
  31          #include "cmp.h"
  32          #include "beep.h"
  33          
  34          u16 cap_res_g[8];
  35          u16 cap_res_lp;
  36          u8 ch;
  37          
  38          void Port_Init(void); //芯片复位后引脚初始化
  39          
  40          void main(void)
  41          {
  42   1        u8  i;
  43   1        u8 j;
  44   1        u32 sum;
  45   1        
  46   1        P_SW2 |= 0x80; //使能XFR
  47   1        
  48   1        Port_Init();  //调用端口初始化函数
  49   1        
  50   1        PWMA_Config();  //调用PWMA初始化函数
  51   1        ADC_Config(); //调用ADC初始化函数
  52   1        CMP_Config(); //调用模拟比较器初始化函数
  53   1        Timer0_Config();  //调用定时器0初始化函数
  54   1        Timer3_Config();  //调用定时器3初始化函数
C51 COMPILER V9.60.0.0   MAIN                                                              01/16/2023 21:40:02 PAGE 2   

  55   1        Timer4_Config();  //调用定时器4初始化函数
  56   1      
  57   1        PWMB_Config();
  58   1        
  59   1        Uart_Config();  //调用串口初始化函数
  60   1        ES = 1;
  61   1        
  62   1        PWM_Set = 0;
  63   1        PWM_Value = 0;
  64   1        timeout = 0;
  65   1        
  66   1        Delay_n_ms(250);
  67   1        beep_1KHz(500);
  68   1        Delay_n_ms(250);
  69   1        
  70   1        EA = 1; //打开总中断
  71   1        
  72   1        UartSendStr("--Brushless ESC Test--\r\n");
  73   1        
  74   1        while(1)
  75   1        {
  76   2          if(t0_flag)
  77   2          {
  78   3            t0_flag = 0;
  79   3            
  80   3            if(timeout != 0)
  81   3            {
  82   4              if(--timeout == 0)
  83   4              {
  84   5                m_running = 0;
  85   5                PWM_Value = 0;
  86   5                CMPCR1 = 0x8c;
  87   5                PWMA_ENO = 0;
  88   5                PWMA_CCR1 = 0;
  89   5                PWMA_CCR2 = 0;
  90   5                PWMA_CCR3 = 0;
  91   5                PWM1_L = 0;
  92   5                PWM2_L = 0;
  93   5                PWM3_L = 0;
  94   5                Delay_n_ms(250);
  95   5              }
  96   4            }
  97   3            if(!m_running && (PWM_Set >= D_START_PWM))
  98   3            {
  99   4              //UartSendStr("-Start-\r\n");
 100   4              m_starting = 1;
 101   4              for(i = 0;i<8;i++) phase_time_tmp[i] = 400; 
 102   4              Motor_Start();
 103   4              m_starting = 0;
 104   4              demagnetizing_cnt = 0;
 105   4              CMPCR1 &= ~0x40;
 106   4              if(step & 1)  CMPCR1 = 0xAC;    //上升沿中断
 107   4              else      CMPCR1 = 0x9C;    //下降沿中断
 108   4              m_running = 1;
 109   4              Delay_n_ms(250);  //延时一下, 先启动起来
 110   4              Delay_n_ms(250);
 111   4              timeout = 125;    //启动超时时间 125*4 = 500ms
 112   4            }
 113   3            if(m_running)
 114   3            {
 115   4              //UartSendStr("-Run-\r\n");
 116   4              if(PWM_Value < PWM_Set) PWM_Value++;
C51 COMPILER V9.60.0.0   MAIN                                                              01/16/2023 21:40:02 PAGE 3   

 117   4              if(PWM_Value > PWM_Set) PWM_Value--;
 118   4              if(PWM_Value<(D_START_PWM-5))
 119   4              {
 120   5                m_running = 0;
 121   5                PWM_Value = 0;
 122   5                CMPCR1 = 0x8c;
 123   5                PWMA_ENO = 0;
 124   5                PWM1_L = 0;
 125   5                PWM2_L = 0;
 126   5                PWM3_L = 0;
 127   5              }
 128   4              PWMA_CCR1L = PWM_Value;
 129   4              PWMA_CCR2L = PWM_Value;
 130   4              PWMA_CCR3L = PWM_Value;
 131   4            }
 132   3            
 133   3            cap_res_g[j] = pwmb_cap_res;
 134   3            j++;
 135   3            j &= 0x07;
 136   3            for(sum = 0,i = 0;i<8;i++)
 137   3            {
 138   4              sum += cap_res_g[i];
 139   4            }
 140   3            cap_res_lp = sum>>3;
 141   3            if(cap_res_lp<1100)
 142   3            {
 143   4              PWM_Set = 25;
 144   4            }
 145   3            else if(cap_res_lp>1900)
 146   3            {
 147   4              PWM_Set = 230;
 148   4            }
 149   3            else if((cap_res_lp>=1100) && (cap_res_lp <= 1900))
 150   3            {
 151   4              PWM_Set = (u8)((cap_res_lp - 1000)>>2);
 152   4            }
 153   3            
 154   3          }
 155   2        }
 156   1      }
 157          
 158          void Port_Init(void)
 159          {
 160   1        P0M0 = 0x00;
 161   1        P0M1 = 0x00; //P0端口初始化为双向口
 162   1        P1M0 = 0x00;
 163   1        P1M1 = 0x00; //P1端口初始化为双向口
 164   1        P2M0 = 0x00;
 165   1        P2M1 = 0x00; //P2端口初始化为双向口
 166   1        P3M0 = 0x00;
 167   1        P3M1 = 0x00; //P3端口初始化为双向口
 168   1        P5M0 = 0x00;
 169   1        P5M0 = 0x00; //P5端口初始化为双向口
 170   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1715    ----
   CONSTANT SIZE    =     25    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     68       9
C51 COMPILER V9.60.0.0   MAIN                                                              01/16/2023 21:40:02 PAGE 4   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
